<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RigNavi MVP</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  :root{
    --bg1:#eff9ff; --bg2:#e9f5ff;
    --ink:#0b2531; --muted:#5a7b8c;
    --glass:#ffffffc9; --line:#d8e9f3;
    --card:#ffffff; --chip:#f4faff;
    --accent:#12b6ff; --accent-ink:#013449;
    --ok:#10b981;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2))}
  header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;padding:14px 18px;backdrop-filter:saturate(140%) blur(10px);background:var(--glass);border-bottom:1px solid var(--line)}
  .brand{font-weight:800;letter-spacing:.1px;display:flex;gap:8px;align-items:center}
  .brand i{font-style:normal;font-size:18px}
  .badge{background:#d6f4ff;color:#067;padding:6px 10px;border-radius:999px;font-size:12px}
  main{max-width:980px;margin:0 auto;padding:16px}
  #hello{margin:4px 0 16px;color:var(--muted)}
  .steps{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .step{border:1px solid var(--line);background:var(--chip);color:var(--muted);border-radius:12px;padding:8px 12px;font-size:13px}
  .step.on{border-color:#bfe9ff;color:#0a4c63;background:#e8f8ff;font-weight:700}
  #back{appearance:none;border:1px solid var(--line);background:#fff;color:var(--ink);padding:10px 14px;border-radius:10px}
  #back[hidden]{display:none}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 22px rgba(23,70,96,.08)}
  h1,h2,h3{margin:.2em 0 .5em} h1{font-size:26px} h3{font-size:18px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
  .chip,button{appearance:none;border:none;cursor:pointer;border-radius:12px;padding:12px 14px;font-size:15px}
  .chip{background:var(--chip)}
  button.pri{background:var(--accent);color:var(--accent-ink);font-weight:800}
  button.ghost{background:#fff;border:1px solid var(--line)}
  a{color:#007fb3}
  ul.items{padding-left:18px;margin:8px 0} ul.items li{margin:10px 0}
  .kv{display:flex;gap:10px;flex-wrap:wrap;margin:.6rem 0}
  .kv span{background:#f6fbff;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px}
  .hero{background:linear-gradient(135deg,#e8f7ff,#ffffff);border:1px dashed var(--line);border-radius:16px;padding:12px;margin-bottom:12px}
  .banner{width:100%;border-radius:14px;border:1px solid var(--line);display:block}
  .shops{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .shop{padding:8px 10px;border-radius:10px;background:#fff;border:1px solid var(--line);font-size:14px}
  .cap{font-size:13px;color:var(--muted);margin:4px 0 8px}
  .sectionTitle{margin-top:12px;margin-bottom:6px;font-weight:800}
  .params{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px}
  .param{display:inline-flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--line);padding:8px 10px;border-radius:999px;font-size:13px}
  .param b{font-weight:800;color:#055}
  .method-chips .chip.on{background:#e8f8ff;border:1px solid #bfe9ff;font-weight:700}
  .memo{font-size:13px;color:#174656;background:#f6fbff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;margin-top:8px}
</style>
</head>
<body>
<header>
  <div class="brand"><i>🎣</i>RigNavi</div>
  <div class="badge">MVP</div>
</header>

<main>
  <div id="hello">起動中…</div>

  <div class="row" style="justify-content:space-between">
    <div class="steps" id="steps"></div>
    <button id="back" class="ghost" hidden onclick="goBack()">戻る</button>
  </div>

  <div id="app"></div>
</main>

<script>
/* ===== 基本設定 ===== */
const LIFF_ID = "2008257307-RwPLYWG1";
const VERSION = "11";

/* ===== ユーティリティ ===== */
function toSlug(s){ return (s||'').toString().toLowerCase().replace(/[^\wぁ-んァ-ン一-龯ー]+/g,'-'); }
function q(s){ return encodeURIComponent(s); }
function linkAmazon(keyword){ return `https://www.amazon.co.jp/s?k=${q(keyword)}&tag=YOURID-22`; }
function linkRakuten(keyword){ return `https://search.rakuten.co.jp/search/mall/${q(keyword)}/?scid=af_pc_etc&icm_cid=YOUR_RAKUTEN_ID`; }

/* ===== 釣法→代表ギア語彙 ===== */
const METHOD_GEAR = {
  "サビキ":["サビキ 仕掛け","トリックサビキ","サビキ用カゴ"],
  "ロケットサビキ":["ロケットカゴ 天秤","サビキ 仕掛け"],
  "ちょい投げ":["ちょい投げ 仕掛け 5号","ナス型オモリ 5〜10号"],
  "投げ":["投げ釣り 仕掛け 天秤","ジェット天秤 15〜25号"],
  "遠投カゴ":["遠投カゴ 仕掛け","カゴ ウキ 仕掛け"],
  "ウキ":["棒ウキ 仕掛け","ウキ止め ゴム"],
  "小ウキ":["小型 玉ウキ 0.5〜1号","シモリ玉"],
  "フカセ":["フカセ 仕掛け","配合エサ オキアミ"],
  "ミャク釣り":["ハリス 0.6〜1号","ガン玉 セット"],
  "胴突き":["胴突き 仕掛け","オモリ 8〜15号"],
  "ブラクリ":["ブラクリ 5〜8号","根魚ワーム"],
  "ヘチ・落とし込み":["ヘチ 仕掛け","ガン玉","落とし込み 竿"],
  "ぶっこみ":["ぶっこみ 仕掛け 夜光鈴","ジェット天秤 25号"],
  "ルアー":["ミノー 9〜12cm","バイブレーション 14〜26g","メタルジグ 20〜40g"],
  "ルアー(軽量)":["アジング ジグヘッド 1g","極小ワーム"],
  "ジギング":["メタルジグ 40〜60g","アシストフック"],
  "エレベーター":["エレベーター 仕掛け","活かしバッカン エアポンプ"],
  "エギング":["エギ 2.5〜3.5号","エギスナップ"],
  "テンヤ":["テンヤ 太刀魚","ワイヤーリーダー"],
  "ワインド":["太刀魚 ワインド セット","ワインド ヘッド"],
  "ハゼクラ":["ハゼ クランク","極小スナップ"]
};

/* ===== 釣法→餌/撒き餌 ===== */
const BAIT_BY_METHOD = {
  "サビキ":["アミエビ 常温（アミ姫）","コマセスプーン"],
  "ロケットサビキ":["ロケットカゴ","アミエビ"],
  "フカセ":["オキアミ","配合エサ グレ用等"],
  "エレベーター":["活アジ/小魚","活かしバケツ"],
  "胴突き":["青イソメ","イカ短冊"],
  "ぶっこみ":["青イソメ束","夜光鈴"],
  "ミャク釣り":["ガン玉","小針 6〜7号"],
  "ウキ":["ウキ止め糸","夜光ウキ"],
  "小ウキ":["小玉ウキ","シモリ玉"],
  "テンヤ":["キビナゴ","サンマ切り身"],
  "ワインド":["太刀魚ワインドワーム"],
  "ハゼクラ":["小型クランク","極小スナップ"]
};

/* ===== 画像（仮） ===== */
const FISH_IMG_FALLBACK = "https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=1200&auto=format&fit=crop";
function fishImg(f){ return `img/fish-${toSlug(f)}.png`; }
function rigImg(fish,method){
  const m = method||"";
  return {
    specific: `img/rig-${toSlug(fish)}-${toSlug(m)}.png`,
    generic:  `img/rig-${toSlug(m)}.png`,
    placeholder: "https://placehold.co/1200x600?text=Rig+Illustration"
  };
}

/* ===== 魚種データ（前回のまま＋多数） ===== */
const FISH_BOOK = {/* ここは前回送付の大辞典そのまま（省略） */};
/* 省略版を入れている場合は、直前バージョンの FISH_BOOK をそのまま残してください。 */

/* ★ 魚種エイリアス：表示はそのまま、解説は別名に寄せる */
const FISH_ALIAS = {
  "ハゼ":"マハゼ",
  "アナゴ":"マアナゴ",
  "コチ":"マゴチ",
  "シーバス":"フッコ"
};
function book(f){ return FISH_BOOK[FISH_ALIAS[f]||f] || {}; }

/* ===== カテゴリ別：場所で使用可にしておく釣法プリセット ===== */
const M_BASE_GOGAN = ["サビキ","ロケットサビキ","ウキ","小ウキ","ちょい投げ","投げ","ミャク釣り","胴突き","ブラクリ","ヘチ・落とし込み","ぶっこみ","フカセ","ルアー","ルアー(軽量)","ジギング","テンヤ","ワインド","エレベーター","エギング"];
const M_BASE_RIVER = ["ウキ","小ウキ","ミャク釣り","ちょい投げ","胴突き","ぶっこみ","ヘチ・落とし込み","ルアー","ルアー(軽量)","フカセ"];
const M_BASE_ESTUARY = ["ウキ","ちょい投げ","胴突き","ぶっこみ","ヘチ・落とし込み","フカセ","ルアー","ルアー(軽量)","ジギング","エレベーター"];
const M_BASE_SURF = ["ちょい投げ","投げ","ぶっこみ","ルアー","ジギング","エレベーター"];

/* ===== 釣り場DB（東京都：ご要望分を追加） ===== */
const DB = [
  /* 既存 */
  { id:"wakasu", pref:"東京都", city:"江東区", name:"若洲海浜公園（海釣り施設・人工磯）",
    address:"江東区若洲3丁目",
    map:"https://maps.google.com/?q=%E8%8B%A5%E6%B4%B2%E6%B5%B7%E6%BF%B1%E5%85%AC%E5%9C%92%20%E6%B5%B7%E9%87%A3%E3%82%8A%E6%96%BD%E8%A8%AD",
    zones:[
      {type:"堤防", fishes:["アジ","イシモチ","コノシロ","メバル","カサゴ","シーバス","サバ","サヨリ"]},
      {type:"テトラ/人工磯", fishes:["カサゴ","メバル","シーバス"]}
    ],
    methods:M_BASE_GOGAN,
    memo:"柵・売店・トイレあり。混雑多め／ライジャケ推奨。"
  },
  { id:"toyosu-gururi", pref:"東京都", city:"江東区", name:"豊洲ぐるり公園（護岸）",
    address:"江東区豊洲6丁目ほか",
    map:"https://maps.google.com/?q=%E8%B1%8A%E6%B4%B2%E3%81%90%E3%82%8B%E3%82%8A%E5%85%AC%E5%9C%92",
    zones:[ {type:"護岸", fishes:["ハゼ","シーバス","メバル","カサゴ","クロダイ","サヨリ","コノシロ"]} ],
    methods:M_BASE_GOGAN,
    memo:"禁止区画あり・撒き餌やロケット天秤禁止／歩行者最優先。"
  },
  { id:"ooi-nagisa", pref:"東京都", city:"品川区/大田区", name:"大井ふ頭中央海浜公園（なぎさの森：しおじ磯 等）",
    address:"品川区八潮4-2-1 周辺",
    map:"https://maps.google.com/?q=%E5%A4%A7%E4%BA%95%E3%81%B5%E9%A0%AD%E4%B8%AD%E5%A4%AE%E6%B5%B7%E6%B5%9C%E5%85%AC%E5%9C%92%20%E3%81%AA%E3%81%8E%E3%81%95%E3%81%AE%E6%A3%AE",
    zones:[ {type:"磯状護岸", fishes:["ハゼ","セイゴ"]} ],
    methods:M_BASE_GOGAN,
    memo:"立入・釣り禁止区画あり／海上公園は投げ原則禁止（アンダー推奨）。"
  },

  /* 追加：東京｜護岸 / 堤防 */
  { id:"keihin-tsubasa", pref:"東京都", city:"大田区", name:"京浜島つばさ公園（第一〜第二護岸）",
    address:"大田区京浜島2丁目",
    map:"https://www.google.com/maps?q=%E4%BA%AC%E6%B5%9C%E5%B3%B6%E3%81%A4%E3%81%B0%E3%81%95%E5%85%AC%E5%9C%92",
    zones:[ {type:"護岸", fishes:["シーバス","カレイ","メバル","ハゼ","サヨリ"]} ],
    methods:M_BASE_GOGAN,
    memo:"柵あり・足場良好。海上公園ルール順守。"
  },
  { id:"keihin-unkou-ryokudo", pref:"東京都", city:"品川区/大田区", name:"京浜運河緑道公園（臨海部運河護岸）",
    address:"品川区東海〜大田区八潮",
    map:"https://www.google.com/maps?q=%E4%BA%AC%E6%B5%9C%E9%81%8B%E6%B2%B3%E7%B7%91%E9%81%93%E5%85%AC%E5%9C%92",
    zones:[ {type:"護岸", fishes:["シーバス","クロダイ","ハゼ"]} ],
    methods:M_BASE_GOGAN,
    memo:"投げ釣り不可。掲示の“釣り可エリア”要確認。"
  },
  { id:"harumibashi", pref:"東京都", city:"江東区", name:"春海橋公園（ガスの科学館前の限定区間）",
    address:"江東区豊洲2〜3丁目",
    map:"https://www.google.com/maps?q=%E6%98%A5%E6%B5%B7%E6%A9%8B%E5%85%AC%E5%9C%92+%E9%87%A3%E3%82%8A",
    zones:[ {type:"護岸", fishes:["シーバス","クロダイ","ハゼ","カレイ"]} ],
    methods:M_BASE_GOGAN,
    memo:"釣り可は約150mのみ／投げ・撒き餌禁止。"
  },
  { id:"shibaura-minami", pref:"東京都", city:"港区", name:"芝浦南ふ頭公園（レインボーブリッジ下）",
    address:"港区港南5丁目",
    map:"https://www.google.com/maps?q=%E8%8A%9D%E6%B5%A6%E5%8D%97%E3%81%B5%E9%A0%AD%E5%85%AC%E5%9C%92",
    zones:[ {type:"護岸", fishes:["アジ","コノシロ","ハゼ","シーバス","クロダイ"]} ],
    methods:M_BASE_GOGAN,
    memo:"投げ禁止・ルアー制限の掲示あり。現地ルール厳守。"
  },
  { id:"shinonome", pref:"東京都", city:"江東区", name:"東雲水辺公園（運河護岸）",
    address:"江東区東雲1丁目",
    map:"https://maps.google.com/?q=%E6%9D%B1%E9%9B%B2%E6%B0%B4%E8%BE%BA%E5%85%AC%E5%9C%92",
    zones:[ {type:"護岸", fishes:["ハゼ","シーバス","カレイ","マアナゴ"]} ],
    methods:M_BASE_GOGAN,
    memo:"風裏になりやすい／トイレあり・駐車場なし。"
  },
  { id:"sunamachi-canal", pref:"東京都", city:"江東区", name:"砂町運河（夢の島緑道公園側 護岸）",
    address:"江東区夢の島3丁目",
    map:"https://maps.google.com/?q=%E7%A0%82%E7%94%BA%E9%81%8B%E6%B2%B3+%E5%A4%A2%E3%81%AE%E5%B3%B6%E7%B7%91%E9%81%93%E5%85%AC%E5%9C%92",
    zones:[ {type:"護岸", fishes:["シーバス"]} ],
    methods:M_BASE_GOGAN,
    memo:"新木場至近。夜間は足元・治安に注意。"
  },
  { id:"omori-hometown", pref:"東京都", city:"大田区", name:"大森ふるさとの浜辺公園（護岸・磯）",
    address:"大田区大森東2丁目",
    map:"https://maps.google.com/?q=%E5%A4%A7%E6%A3%AE%E3%81%B5%E3%82%8B%E3%81%95%E3%81%A8%E3%81%AE%E6%B5%9C%E8%BE%BA%E5%85%AC%E5%9C%92",
    zones:[ {type:"護岸", fishes:["ハゼ","シーバス"]}, {type:"磯", fishes:["ハゼ","シーバス"]} ],
    methods:M_BASE_GOGAN,
    memo:"砂浜は釣り禁止／両端の磯や護岸のみ可。リール投げ禁止。"
  },

  /* 東京｜河口付近 */
  { id:"sunamachi-mizube", pref:"東京都", city:"江東区", name:"砂町水辺公園（荒川下流・江東区側）",
    address:"東砂7〜8丁目（荒川沿い）",
    map:"https://maps.google.com/?q=%E7%A0%82%E7%94%BA%E6%B0%B4%E8%BE%BA%E5%85%AC%E5%9C%92",
    zones:[ {type:"河口（ゴロタ）", fishes:["ハゼ","シーバス","クロダイ","ボラ"]} ],
    methods:M_BASE_ESTUARY,
    memo:"ゴロタで根掛かり・滑り注意／トイレ点在。"
  },
  { id:"arakawa-estuary", pref:"東京都", city:"江東区", name:"荒川河口（清砂大橋〜新砂水辺公園・新砂RS）",
    address:"清砂〜新砂",
    map:"https://maps.google.com/?q=%E6%B8%85%E7%A0%82%E5%A4%A7%E6%A9%8B%20%E6%96%B0%E7%A0%82%E6%B0%B4%E8%BE%BA%E5%85%AC%E5%9C%92",
    zones:[ {type:"河口（ゴロタ）", fishes:["シーバス","クロダイ","ハゼ"]} ],
    methods:M_BASE_ESTUARY,
    memo:"ゴロタ護岸。潮の動き出しと橋脚明暗が鍵。"
  },
  { id:"shinsuna-rs", pref:"東京都", city:"江東区", name:"清砂大橋下〜新砂リバーステーション",
    address:"江東区新砂1〜東砂8",
    map:"https://www.google.com/maps?q=%E6%B8%85%E7%A0%82%E5%A4%A7%E6%A9%8B",
    zones:[ {type:"河口", fishes:["クロダイ","シーバス","ハゼ"]} ],
    methods:M_BASE_ESTUARY,
    memo:"カニ餌のチニング実績／足場不安定区間あり。"
  },
  { id:"old-edogawa-mouth", pref:"東京都", city:"江戸川区", name:"旧江戸川 河口西岸（臨海町護岸）",
    address:"江戸川区臨海町6丁目周辺",
    map:"https://www.google.com/maps?q=%E6%97%A7%E6%B1%9F%E6%88%B8%E5%B7%9D+%E6%B2%B3%E5%8F%A3+%E8%87%A8%E6%B5%B7%E7%94%BA",
    zones:[ {type:"河口", fishes:["シーバス","サッパ","ハゼ","クロダイ"]} ],
    methods:M_BASE_ESTUARY,
    memo:"橋脚・常夜灯の明暗が強い／休日は混雑。"
  },
  { id:"tamagawa-daishi", pref:"東京都", city:"大田区", name:"多摩川・大師橋〜羽田（東京都側）",
    address:"大師橋〜羽田",
    map:"https://maps.google.com/?q=%E5%A4%9A%E6%91%A9%E5%B7%9D%20%E5%A4%A7%E5%B8%AB%E6%A9%8B",
    zones:[ {type:"河口/護岸", fishes:["ハゼ","セイゴ","マゴチ"]} ],
    methods:M_BASE_ESTUARY,
    memo:"満干差大。橋脚ヨレ・潮位変化を意識。"
  },
  { id:"ebitorigawa", pref:"東京都", city:"大田区", name:"海老取川（弁天橋〜天空橋周辺）",
    address:"羽田5〜6丁目",
    map:"https://www.google.com/maps?q=%E6%B5%B7%E8%80%81%E5%8F%96%E5%B7%9D+%E5%BC%81%E5%A4%A9%E6%A9%8B",
    zones:[ {type:"河口", fishes:["ハゼ","セイゴ","クロダイ","ウナギ"]} ],
    methods:M_BASE_ESTUARY,
    memo:"合流点が人気。手すり無区間あり／看板に従う。"
  },
  { id:"kandagawa-mouth", pref:"東京都", city:"台東区/中央区", name:"神田川河口・柳橋（隅田川合流）",
    address:"台東区柳橋〜中央区東日本橋",
    map:"https://maps.google.com/?q=%E6%9F%B3%E6%A9%8B+%E7%A5%9E%E7%94%B0%E5%B7%9D",
    zones:[ {type:"河口", fishes:["シーバス","カレイ","ウナギ","ハゼ"]} ],
    methods:M_BASE_ESTUARY,
    memo:"屋形船・遊覧船の航行が多い。安全最優先。"
  },
  { id:"sunamachi-tennis", pref:"東京都", city:"江東区", name:"砂町庭球場前護岸（荒川・東砂）",
    address:"江東区東砂7〜8丁目",
    map:"https://maps.google.com/?q=%E7%A0%82%E7%94%BA%E5%BA%AD%E7%90%83%E5%A0%B4",
    zones:[ {type:"河口", fishes:["セイゴ","ハゼ"]} ],
    methods:M_BASE_ESTUARY,
    memo:"足場高く落水リスク／赤エイ情報あり。"
  },

  /* 東京｜川・運河等 */
  { id:"kyunakagawa", pref:"東京都", city:"江東区/江戸川区", name:"旧中川（東大島駅〜中川大橋）",
    address:"東大島周辺",
    map:"https://maps.google.com/?q=%E6%97%A7%E4%B8%AD%E5%B7%9D%20%E6%9D%B1%E5%A4%A7%E5%B3%B6",
    zones:[ {type:"河川（ゴロタ/橋脚）", fishes:["ハゼ","セイゴ"]} ],
    methods:M_BASE_RIVER,
    memo:"夏〜初秋のデイ好調。ゴロタの石間狙いも。"
  },
  { id:"hirai-undo", pref:"東京都", city:"江戸川区", name:"平井運動公園（荒川右岸×旧中川合流域）",
    address:"江戸川区平井荒川グラウンド",
    map:"https://maps.google.com/?q=%E5%B9%B3%E4%BA%95%E9%81%8B%E5%8B%95%E5%85%AC%E5%9C%92%20%E8%8D%92%E5%B7%9D",
    zones:[ {type:"河川護岸/橋脚", fishes:["シーバス","ハゼ","コイ","ウナギ"]} ],
    methods:M_BASE_RIVER,
    memo:"河川敷Pは土日祝のみ開放／簡易トイレ中心。"
  },
  { id:"yokojikken", pref:"東京都", city:"江東区", name:"横十間川親水公園（運河）",
    address:"大島・北砂周辺",
    map:"https://maps.google.com/?q=%E6%A8%AA%E5%8D%81%E9%96%93%E5%B7%9D%E8%A6%AA%E6%B0%B4%E5%85%AC%E5%9C%92",
    zones:[ {type:"運河", fishes:["ハゼ","テナガエビ"]} ],
    methods:M_BASE_RIVER,
    memo:"ファミリー向け。橋回りの陰や足元の敷石が狙い目。"
  },
  { id:"mizumoto", pref:"東京都", city:"葛飾区", name:"水元公園（淡水：池・水路）",
    address:"葛飾区 水元公園",
    map:"https://maps.google.com/?q=%E6%B0%B4%E5%85%83%E5%85%AC%E5%9C%92",
    zones:[ {type:"池・水路", fishes:["コイ","フナ","ヘラブナ","テナガエビ"]} ],
    methods:["ウキ","ミャク釣り"],
    memo:"園内釣り可（一部施設除く）／P・トイレ多数。"
  },
  { id:"old-edogawa-shinozaki", pref:"東京都", city:"江戸川区", name:"旧江戸川（篠崎緑地A〜B／篠崎水門周辺）",
    address:"上篠崎・篠崎町",
    map:"https://www.google.com/maps?q=%E7%AF%A0%E5%B4%8E%E7%B7%91%E5%9C%B0+%E6%97%A7%E6%B1%9F%E6%88%B8%E5%B7%9D",
    zones:[ {type:"河川", fishes:["ハゼ","シーバス","クロダイ","コイ"]} ],
    methods:M_BASE_RIVER,
    memo:"落ちハゼ期◎。長い護岸で分散しやすい。"
  },
  { id:"arakawa-lockgate", pref:"東京都", city:"江戸川区", name:"荒川ロックゲート（旧中川連絡水門）",
    address:"小松川1-1地先",
    map:"https://www.google.com/maps?q=%E8%8D%92%E5%B7%9D%E3%83%AD%E3%83%83%E3%82%AF%E3%82%B2%E3%83%BC%E3%83%88",
    zones:[ {type:"水門/明暗", fishes:["シーバス","クロダイ","ハゼ"]} ],
    methods:M_BASE_RIVER,
    memo:"明暗と反転流を撃つ。フェンスありで足場良。"
  },
  { id:"rokugo-sluice", pref:"東京都", city:"大田区", name:"六郷水門（多摩川×呑川合流）",
    address:"仲六郷4丁目",
    map:"https://www.google.com/maps?q=%E5%85%AD%E9%83%B7%E6%B0%B4%E9%96%80",
    zones:[ {type:"水門/合流", fishes:["ハゼ","テナガエビ","セイゴ","クロダイ"]} ],
    methods:M_BASE_RIVER,
    memo:"歩行者・自転車多め。キャスト角度は控えめに。"
  },
  { id:"sumidagawa-terrace", pref:"東京都", city:"中央区/江東区", name:"隅田川テラス（新大橋〜清洲橋 左岸）",
    address:"新大橋〜清洲橋",
    map:"https://www.google.com/maps?q=%E9%9A%85%E7%94%B0%E5%B7%9D+%E6%96%B0%E5%A4%A7%E6%A9%8B",
    zones:[ {type:"テラス", fishes:["ハゼ","シーバス"]} ],
    methods:M_BASE_RIVER,
    memo:"テラスは投げ込み不可が基本。安全最優先でアンダー主体。"
  },
  { id:"onagigawa-clover", pref:"東京都", city:"江東区", name:"小名木川 クローバー橋周辺（横十間川合流部）",
    address:"扇橋3〜猿江2丁目",
    map:"https://www.google.com/maps?q=%E5%B0%8F%E5%90%8D%E6%9C%A8%E5%B7%9D+%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%90%E3%83%BC%E6%A9%8B",
    zones:[ {type:"合流部", fishes:["ハゼ","セイゴ"]} ],
    methods:M_BASE_RIVER,
    memo:"合流部の淀みと敷石のキワが鍵。駅近で足場良。"
  },
  { id:"ogibashi-lock", pref:"東京都", city:"江東区", name:"扇橋閘門〜新扇橋（小名木川）",
    address:"江東区扇橋",
    map:"https://maps.google.com/?q=%E6%89%87%E6%A9%8B%E9%96%98%E9%96%80",
    zones:[ {type:"河川", fishes:["ハゼ"]} ],
    methods:M_BASE_RIVER,
    memo:"内部河川で流れ緩め／遊歩道利用者多い。"
  },
  { id:"horikiri-mizube", pref:"東京都", city:"葛飾区", name:"堀切水辺公園（荒川左岸・堀切橋周辺）",
    address:"堀切1〜2丁目",
    map:"https://maps.google.com/?q=%E5%A0%80%E5%88%87%E6%B0%B4%E8%BE%BA%E5%85%AC%E5%9C%92",
    zones:[ {type:"河川", fishes:["シーバス","マゴチ","コイ","タイ","ハゼ"]} ],
    methods:M_BASE_RIVER,
    memo:"駅徒歩圏。段差・滑りに注意。"
  },
  { id:"kinegawa-bashi", pref:"東京都", city:"葛飾区", name:"木根川橋（荒川・綾瀬川合流）",
    address:"東四つ木付近",
    map:"https://maps.google.com/?q=%E6%9C%A8%E6%A0%B9%E5%B7%9D%E6%A9%8B",
    zones:[ {type:"河川", fishes:["ソウギョ","コイ","シーバス","ウナギ"]} ],
    methods:M_BASE_RIVER,
    memo:"浅場多く、ウェーディング適所あり。"
  },
  { id:"kitajukken-skytree", pref:"東京都", city:"墨田区", name:"北十間川（押上・スカイツリー前）",
    address:"押上1〜2丁目",
    map:"https://maps.google.com/?q=%E5%8C%97%E5%8D%81%E9%96%93%E5%B7%9D+%E6%8A%BC%E4%B8%8A",
    zones:[ {type:"運河", fishes:["ハゼ"]} ],
    methods:M_BASE_RIVER,
    memo:"テラスで足場良。夏〜秋のファミリー定番。"
  },
  { id:"iwabuchi-sluice", pref:"東京都", city:"北区", name:"岩淵水門（旧岩淵水門〜中ノ島）",
    address:"北区岩淵町",
    map:"https://maps.google.com/?q=%E5%B2%A9%E6%B7%B5%E6%B0%B4%E9%96%80",
    zones:[ {type:"水門/島周り", fishes:["テナガエビ","シーバス","ハゼ","ウナギ","コイ"]} ],
    methods:M_BASE_RIVER,
    memo:"桟橋や島周りの地形変化を狙う。滑り・転落注意。"
  },
  { id:"shinarakawa-ohashi", pref:"東京都", city:"北区/足立区", name:"新荒川大橋（北区／足立区境）",
    address:"北区神谷〜足立区新田",
    map:"https://maps.google.com/?q=%E6%96%B0%E8%8D%92%E5%B7%9D%E5%A4%A7%E6%A9%8B",
    zones:[ {type:"橋脚/河川", fishes:["テナガエビ","ハゼ","チチブ","シーバス"]} ],
    methods:M_BASE_RIVER,
    memo:"船舶通行多い。仕掛け回収はこまめに。"
  },
  { id:"shikahama-bashi", pref:"東京都", city:"足立区", name:"鹿浜橋（荒川）",
    address:"足立区鹿浜",
    map:"https://maps.google.com/?q=%E9%B9%BF%E6%B5%9C%E6%A9%8B",
    zones:[ {type:"橋脚/河川", fishes:["ハゼ","シーバス","ウナギ"]} ],
    methods:M_BASE_RIVER,
    memo:"橋脚の明暗が分かれ目。深夜帯はマナー徹底。"
  },

  /* 東京｜サーフ */
  { id:"kasai-kaisui", pref:"東京都", city:"江戸川区", name:"葛西海浜公園（西なぎさ・外海側の指定区間）",
    address:"臨海町6丁目付近",
    map:"https://www.google.com/maps?q=%E8%91%9B%E8%A5%BF%E6%B5%B7%E6%B5%9C%E5%85%AC%E5%9C%92+%E8%A5%BF%E3%81%AA%E3%81%8E%E3%81%95",
    zones:[ {type:"サーフ", fishes:["ハゼ","カレイ","シーバス","クロダイ"]} ],
    methods:M_BASE_SURF,
    memo:"釣り可エリアは限定／投げ・フルキャスト不可。アンダー主体で安全第一。"
  }
];

/* 都道府県一覧 */
const PREFS = [...new Set(DB.map(p=>p.pref))];

/* ===== 状態 & ステップ ===== */
const state = { step:0, pref:null, placeId:null, zoneIdx:null, fish:null, subMethod:null };
const stepsTitle = ["都道府県","釣り場","ポイント種別","魚種","結果"];

function setSteps(){
  const s = document.getElementById('steps');
  s.innerHTML = stepsTitle.map((t,i)=>`<div class="step ${i<=state.step?'on':''}">${i+1}. ${t}</div>`).join('');
  document.getElementById('back').hidden = state.step===0;
}

/* ===== 描画 ===== */
function render(){
  setSteps();
  const app = document.getElementById('app');

  // 0: 都道府県
  if(state.step===0){
    app.innerHTML = `<div class="hero"><strong>都道府県</strong> を選ぶと、その地域の釣り場が出ます。</div>
    <div class="grid">
      ${PREFS.map(p=>{
        const n = DB.filter(d=>d.pref===p).length;
        return `<div class="card">
          <h3>${p}</h3>
          <p class="muted">${n} スポット</p>
          <div class="row"><button class="pri" onclick="selPref('${p}')">この都道府県を選ぶ</button></div>
        </div>`}).join('')}
    </div>`;
    return;
  }

  // 1: 釣り場（★メモ＆釣果例を追加表示）
  if(state.step===1){
    const list = DB.filter(d=>d.pref===state.pref);
    app.innerHTML = `<div class="grid">
      ${list.map(d=>{
        const fishes = [...new Set((d.zones||[]).flatMap(z=>z.fishes))].slice(0,8).join("、");
        return `<div class="card">
          <h3>${d.name}</h3>
          <div class="kv"><span>${d.pref} ${d.city||""}</span><span>${d.address||""}</span></div>
          <p class="muted">釣果例：${fishes||'—'}</p>
          ${d.memo?`<div class="memo">一口メモ・注意事項：${d.memo}</div>`:''}
          <div class="row" style="margin-top:8px">
            <button class="ghost" onclick="openMap('${d.id}')">地図を開く</button>
            <button class="pri" onclick="selPlace('${d.id}')">ここを選ぶ</button>
          </div>
        </div>`}).join('')}
    </div>`;
    return;
  }

  // 2: ポイント種別
  if(state.step===2){
    const p = getPlace();
    app.innerHTML = `
      <div class="card">
        <h3>${p.name}｜ポイントを選ぶ</h3>
        <div class="chips">
          ${p.zones.map((z,idx)=>`<button class="chip" onclick="selZone(${idx})">${z.type}</button>`).join('')}
        </div>
      </div>`;
    return;
  }

  // 3: 魚種
  if(state.step===3){
    const z = getZone();
    app.innerHTML = `
      <div class="card">
        <h3>${getPlace().name}｜${z.type}｜魚種を選ぶ</h3>
        <div class="chips">
          ${z.fishes.map(f=>`<button class="chip" onclick="selFish('${f}')">${f}</button>`).join('')}
        </div>
      </div>`;
    return;
  }

  // 4: 結果（★現地ルールは表示しない）
  if(state.step===4){
    app.innerHTML = renderResult();
    return;
  }
}

function renderResult(){
  const p = getPlace(), z = getZone(), f = state.fish;
  const info = book(f);
  const placeMethods = (p.methods||[]);
  const allowed = (info.methods||[]).filter(m => placeMethods.includes(m));
  if(!state.subMethod) state.subMethod = allowed[0] || null;

  const fimg = fishImg(f);
  const rimg = rigImg(f, state.subMethod);

  const params = `
    <div class="params">
      <div class="param"><b>シーズン</b> ${info.season||"—"}</div>
      <div class="param"><b>時間帯</b> ${info.time||"—"}</div>
    </div>`;

  const methodChips = `
    <div class="chips method-chips">
      ${allowed.map(m=>`<button class="chip ${m===state.subMethod?'on':''}" onclick="pickMethod('${m}')">${m}</button>`).join('') || '<p class="muted">この場所で推奨される釣法データが未設定です</p>'}
    </div>`;

  const gearWords = new Set([...(info.gear||[])]);
  (METHOD_GEAR[state.subMethod]||[]).forEach(w=>gearWords.add(w));
  const gearList = [...gearWords].slice(0,6);

  const baitWords = new Set([...(info.bait||[])]);
  (BAIT_BY_METHOD[state.subMethod]||[]).forEach(w=>baitWords.add(w));
  const baitList = [...baitWords];

  const lureList = info.lures||[];

  return `
  <div class="card">
    <div class="sectionTitle">指定した魚画像 ↓</div>
    <img class="banner" src="${fimg}" alt="${f}" onerror="this.onerror=null;this.src='${FISH_IMG_FALLBACK}';">

    <div class="sectionTitle">仕掛けイラスト ↓</div>
    <img class="banner" src="${rimg.specific}" alt="${state.subMethod||''} rig"
         onerror="if(this.src.indexOf('rig-')>-1){this.src='${rimg.generic}';this.onerror=function(){this.src='${rimg.placeholder}';}}">

    <h3 style="margin-top:10px">${p.name}</h3>
    <div class="kv"><span>${z.type}</span><span>魚種：${f}</span></div>
    ${params}

    <div class="sectionTitle">この場所での推奨釣り方（切り替え可）</div>
    ${methodChips}

    <div class="sectionTitle">オススメ部材 ↓</div>
    ${gearList.length?`<ul class="items">
      ${gearList.map(w=>`<li>${w}
        <div class="shops">
          <a class="shop" href="#" onclick="ext('${linkAmazon(w)}')">Amazon</a>
          <a class="shop" href="#" onclick="ext('${linkRakuten(w)}')">楽天</a>
        </div>
      </li>`).join('')}
    </ul>`:'<p class="muted">準備中</p>'}

    <div class="sectionTitle">餌・撒き餌のオススメ ↓</div>
    ${baitList.length?`<ul class="items">
      ${baitList.map(w=>`<li>${w}
        <div class="shops">
          <a class="shop" href="#" onclick="ext('${linkAmazon(w)}')">Amazon</a>
          <a class="shop" href="#" onclick="ext('${linkRakuten(w)}')">楽天</a>
        </div>
      </li>`).join('')}
    </ul>`:'<p class="muted">準備中</p>'}

    ${lureList.length?`<div class="sectionTitle">ルアー候補 ↓</div>
      <ul class="items">
        ${lureList.map(w=>`<li>${w}
          <div class="shops">
            <a class="shop" href="#" onclick="ext('${linkAmazon(w)}')">Amazon</a>
            <a class="shop" href="#" onclick="ext('${linkRakuten(w)}')">楽天</a>
          </div>
        </li>`).join('')}
      </ul>`:''}

    <div class="sectionTitle">棚、狙い目 ↓</div>
    <p>${(book(f).shelf)||p.shelf||'—'}</p>

    <div class="sectionTitle">おすすめ時間帯 ↓</div>
    <p>${(book(f).time)||p.times||'—'}</p>

    <div class="sectionTitle">場所と友だち共有</div>
    <div class="row" style="margin-top:6px">
      <button class="ghost" onclick="openMap('${p.id}')">場所を地図で確認</button>
      <button class="pri" onclick="share()">友だちに共有</button>
    </div>

    <p class="cap">食べ方ヒント：${(book(f).food)||'—'}</p>
  </div>`;
}

/* ===== ハンドラ ===== */
function getPlace(){ return DB.find(p=>p.id===state.placeId); }
function getZone(){ const p = getPlace(); return p?.zones?.[state.zoneIdx]; }
function openWin(url){ return liff.isInClient()? liff.openWindow({url, external:true}) : window.open(url,'_blank'); }
function openMap(pid){ const url = DB.find(p=>p.id===pid).map; openWin(url); }
function ext(url){ openWin(url); }

function selPref(p){ state.pref=p; state.step=1; render(); }
function selPlace(id){ state.placeId=id; state.step=2; render(); }
function selZone(idx){ state.zoneIdx=idx; state.step=3; render(); }
function selFish(f){ state.fish=f; state.subMethod=null; state.step=4; render(); }
function pickMethod(m){ state.subMethod=m; document.getElementById('app').innerHTML = renderResult(); }

function goBack(){
  if(state.step===0) return;
  if(state.step===1){ state.pref=null; }
  if(state.step===2){ state.placeId=null; }
  if(state.step===3){ state.zoneIdx=null; }
  if(state.step===4){ state.fish=null; state.subMethod=null; }
  state.step--; render();
}

/* ===== LIFF 起動 ===== */
(async()=>{
  await liff.init({ liffId: LIFF_ID });
  if (liff.isInClient()){
    if(!liff.isLoggedIn()){ liff.login({ prompt:"consent" }); return; }
    try{
      const p = await liff.getProfile();
      document.getElementById('hello').textContent = `ようこそ ${p.displayName} さん`;
    }catch{ document.getElementById('hello').textContent = "ようこそ！"; }
  }else{
    document.getElementById('hello').textContent = "ブラウザでプレビュー中";
  }
  render();
})();

async function share(){
  if(!liff.isInClient()){ alert('共有はLINEアプリ内で開いてください'); return; }
  const p = getPlace(), z = getZone();
  const f = state.fish, m = state.subMethod||'';
  const b = book(f);
  const msg = `${p.name}\n${z.type}\n${f}${m?` × ${m}`:''}\n季節:${b.season||'-'}／時間帯:${b.time||'-'}\n棚:${b.shelf||p.shelf||'-'}\n地図:${p.map}`;
  await liff.shareTargetPicker([{ type:'text', text: msg }]);
}
</script>
</body>
</html>
