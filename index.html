<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RigNavi MVP</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  :root{
    --bg1:#eff9ff; --bg2:#e9f5ff;
    --ink:#0b2531; --muted:#5a7b8c;
    --glass:#ffffffc9; --line:#d8e9f3;
    --card:#ffffff; --chip:#f4faff;
    --accent:#12b6ff; --accent-ink:#013449;
    --ok:#10b981;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:linear-gradient(180deg,var(--bg1),var(--bg2));
  }
  header{
    position:sticky; top:0; z-index:10;
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 18px; backdrop-filter:saturate(140%) blur(10px);
    background:var(--glass); border-bottom:1px solid var(--line);
  }
  .brand{font-weight:800; letter-spacing:.1px; display:flex; gap:8px; align-items:center}
  .brand i{font-style:normal; font-size:18px}
  .badge{background:#d6f4ff; color:#067; padding:6px 10px; border-radius:999px; font-size:12px}
  main{max-width:980px; margin:0 auto; padding:16px}
  #hello{margin:4px 0 16px; color:var(--muted)}
  .steps{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
  .step{border:1px solid var(--line); background:var(--chip); color:var(--muted);
        border-radius:12px; padding:8px 12px; font-size:13px}
  .step.on{border-color:#bfe9ff; color:#0a4c63; background:#e8f8ff; font-weight:700}
  #back{appearance:none; border:1px solid var(--line); background:#fff; color:var(--ink);
        padding:10px 14px; border-radius:10px}
  #back[hidden]{display:none}

  .grid{display:grid; gap:12px; grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:16px;
    padding:16px; box-shadow:0 10px 22px rgba(23,70,96,.08);
  }
  h1,h2,h3{margin:.2em 0 .5em}
  h1{font-size:26px} h3{font-size:18px}
  .muted{color:var(--muted)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .chips{display:flex; flex-wrap:wrap; gap:10px; margin-top:8px}
  .chip,button{appearance:none; border:none; cursor:pointer; border-radius:12px; padding:12px 14px; font-size:15px}
  .chip{background:var(--chip)}
  button.pri{background:var(--accent); color:var(--accent-ink); font-weight:800}
  button.ghost{background:#fff; border:1px solid var(--line)}
  a{color:#007fb3}
  ul.items{padding-left:18px; margin:8px 0}
  ul.items li{margin:10px 0}
  .kv{display:flex; gap:10px; flex-wrap:wrap; margin:.6rem 0}
  .kv span{background:#f6fbff; border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12px}
  .hero{background:linear-gradient(135deg,#e8f7ff,#ffffff); border:1px dashed var(--line); border-radius:16px; padding:12px; margin-bottom:12px}
  .banner{width:100%; border-radius:14px; border:1px solid var(--line); display:block}
  .shops{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
  .shop{padding:8px 10px; border-radius:10px; background:#fff; border:1px solid var(--line); font-size:14px}
  .cap{font-size:13px; color:var(--muted); margin:4px 0 8px}
  .sectionTitle{margin-top:12px; margin-bottom:6px; font-weight:800}

  .params{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 10px}
  .param{display:inline-flex; align-items:center; gap:6px; background:#fff; border:1px solid var(--line);
         padding:8px 10px; border-radius:999px; font-size:13px}
  .param b{font-weight:800; color:#055}
  .method-chips .chip.on{background:#e8f8ff; border:1px solid #bfe9ff; font-weight:700}
</style>
</head>
<body>
<header>
  <div class="brand"><i>🎣</i>RigNavi</div>
  <div class="badge">MVP</div>
</header>

<main>
  <div id="hello">起動中…</div>

  <div class="row" style="justify-content:space-between">
    <div class="steps" id="steps"></div>
    <button id="back" class="ghost" hidden onclick="goBack()">戻る</button>
  </div>

  <div id="app"></div>
</main>

<script>
/* ===== 基本設定 ===== */
const LIFF_ID = "2008257307-RwPLYWG1";
const VERSION = "10";

/* ========= 汎用：スラグ & 簡易リンク生成 ========= */
function toSlug(s){ return (s||'').toString().toLowerCase().replace(/[^\wぁ-んァ-ン一-龯ー]+/g,'-'); }
function q(s){ return encodeURIComponent(s); }
function linkAmazon(keyword){ return `https://www.amazon.co.jp/s?k=${q(keyword)}&tag=YOURID-22`; }
function linkRakuten(keyword){ return `https://search.rakuten.co.jp/search/mall/${q(keyword)}/?scid=af_pc_etc&icm_cid=YOUR_RAKUTEN_ID`; }

/* ========= 釣法→代表ギア語彙（自動で商品検索リンク化） ========= */
const METHOD_GEAR = {
  "サビキ":["サビキ 仕掛け","トリックサビキ","サビキ用カゴ"],
  "ロケットサビキ":["ロケットカゴ 天秤","サビキ 仕掛け"],
  "ちょい投げ":["ちょい投げ 仕掛け 5号","ナス型オモリ 5〜10号"],
  "投げ":["投げ釣り 仕掛け 天秤","ジェット天秤 15〜25号"],
  "遠投カゴ":["遠投カゴ 仕掛け","カゴ ウキ 仕掛け"],
  "ウキ":["棒ウキ 仕掛け","ウキ止め ゴム"],
  "小ウキ":["小型 玉ウキ 0.5〜1号","シモリ玉"],
  "フカセ":["フカセ 仕掛け","配合エサ オキアミ"],
  "ミャク釣り":["ハリス 0.6〜1号","ガン玉 セット"],
  "胴突き":["胴突き 仕掛け","オモリ 8〜15号"],
  "ブラクリ":["ブラクリ 5〜8号","根魚ワーム"],
  "ヘチ・落とし込み":["ヘチ 仕掛け","ガン玉","落とし込み 竿"],
  "ぶっこみ":["ぶっこみ 仕掛け 夜光鈴","ジェット天秤 25号"],
  "ルアー":["ミノー 9〜12cm","バイブレーション 14〜26g","メタルジグ 20〜40g"],
  "ルアー(軽量)":["アジング ジグヘッド 1g","極小ワーム"],
  "ジギング":["メタルジグ 40〜60g","アシストフック"],
  "エレベーター":["エレベーター 仕掛け","活かしバッカン エアポンプ"],
  "エギング":["エギ 2.5〜3.5号","エギスナップ"],
  "テンヤ":["テンヤ 太刀魚","ワイヤーリーダー"],
  "ワインド":["太刀魚 ワインド セット","ワインド ヘッド"],
  "ハゼクラ":["ハゼ クランク","極小スナップ"]
};

/* ========= 釣法→餌/撒き餌（釣法別） ========= */
const BAIT_BY_METHOD = {
  "サビキ":["アミエビ 常温（アミ姫）","コマセスプーン"],
  "ロケットサビキ":["ロケットカゴ","アミエビ"],
  "フカセ":["オキアミ","配合エサ グレ用等"],
  "エレベーター":["活アジ/小魚","活かしバケツ"],
  "胴突き":["青イソメ","イカ短冊"],
  "ぶっこみ":["青イソメ束","夜光鈴"],
  "ミャク釣り":["ガン玉","小針 6〜7号"],
  "ウキ":["ウキ止め糸","夜光ウキ"],
  "小ウキ":["小玉ウキ","シモリ玉"],
  "テンヤ":["キビナゴ","サンマ切り身"],
  "ワインド":["太刀魚ワインドワーム"],
  "ハゼクラ":["小型クランク","極小スナップ"]
};

/* ========= 魚画像（仮） & 仕掛けイラストの優先規則 ========= */
const FISH_IMG_FALLBACK = "https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=1200&auto=format&fit=crop";
const FISH_IMAGES = {}; // 任意：img/fish-<slug>.png を置けば自動表示、なければ Unsplash系にフォールバック
function fishImg(f){
  const local = `img/fish-${toSlug(f)}.png`;
  return local; // 実在判定はできないため onerror で非表示→フォールバック
}
function rigImg(fish,method){
  const m = method||"";
  const localSpecific = `img/rig-${toSlug(fish)}-${toSlug(m)}.png`;
  const localGeneric  = `img/rig-${toSlug(m)}.png`;
  const placeholder = "https://placehold.co/1200x600?text=Rig+Illustration";
  // 実在判定はできないので local を返して onerror で次へ
  return {specific:localSpecific, generic:localGeneric, placeholder};
}

/* ========= 魚種データ（いただいたリストを反映） =========
   season/time/shelf/methods/bait/lures/food/gear(任意) */
const FISH_BOOK = {
  /* 小型回遊魚・ベイト系 */
  "豆アジ": {season:"初夏〜秋（6–11月）", time:"朝夕マズメ／夜の常夜灯", shelf:"表層〜中層（常夜灯直下は浅め）",
             methods:["サビキ","ウキ","ロケットサビキ","ちょい投げ"], bait:["アミエビ"],
             lures:["マイクロジグ","0.5–1g ジグヘッド＋極小ワーム"], food:"南蛮漬け／唐揚げ",
             gear:["極小サビキ 0.5–1号","ウキサビキ"]},
  "アジ": {season:"初夏〜秋（越冬群れも）", time:"朝夕／夜常夜灯", shelf:"中層〜底寄り（船道・潮目・明暗）",
           methods:["サビキ","ロケットサビキ","ウキ","ちょい投げ","遠投カゴ","ルアー(軽量)"],
           bait:["アミエビ","オキアミ","青イソメ"], lures:["1–2g ジグヘッド＋ワーム","7–20g メタル","フロート/キャロ"],
           food:"刺身／なめろう／フライ／南蛮漬け"},
  "イワシ": {season:"春〜秋", time:"朝夕中心（群れ次第）", shelf:"表層〜中層（潮目・明暗）",
            methods:["サビキ","ウキ"], bait:["アミエビ"], lures:["マイクロジグ","小スプーン"], food:"刺身／天ぷら／梅煮／酢漬け"},
  "サッパ": {season:"夏〜秋", time:"日中〜夜（常夜灯）", shelf:"表層〜中層",
            methods:["サビキ","ウキ"], bait:["アミエビ"], lures:["小型ジグ","ミノー"], food:"南蛮漬け／酢締め"},
  "コハダ": {season:"初夏〜秋", time:"朝夕〜夜", shelf:"表層〜中層（群れ打ち）",
            methods:["サビキ","ウキ","カゴ"], bait:["アミエビ"], lures:["小型メタル","ミノー"], food:"酢締め"},
  "コノシロ": {season:"初夏〜晩秋", time:"朝夕〜夜", shelf:"表層〜中層",
            methods:["サビキ","ウキ","カゴ"], bait:["アミエビ"], lures:["小型メタル","ミノー"], food:"南蛮漬け／酢締め"},
  "サバ": {season:"夏〜秋", time:"朝夕", shelf:"中層（潮目直撃）",
          methods:["遠投カゴ","サビキ","ジギング"], bait:["オキアミ","アミエビ"], lures:["20–40g メタル","ミノー","バイブ"], food:"塩焼き／味噌煮／しめ鯖※要冷凍"},
  "サヨリ": {season:"秋〜冬", time:"日中〜夕（凪◎）", shelf:"表層",
           methods:["ウキ","遠投カゴ"], bait:["ササミ赤染め","アミ","オキアミ"], lures:["フロート＋極小ジグヘッド"], food:"刺身・昆布締め／天ぷら"},
  "カマス": {season:"秋〜初冬", time:"朝夕／夜（常夜灯）", shelf:"中層〜表層",
           methods:["ウキ","ルアー"], bait:["キビナゴ","ササミ"], lures:["小型ミノー","メタル","ジグサビキ"], food:"塩焼き／一夜干し／フライ"},

  /* 根魚・沿岸・底物 */
  "メバル": {season:"冬〜春", time:"夜（常夜灯）", shelf:"表層〜中層（明暗・角・係留船）",
           methods:["ウキ","胴突き","ルアー(軽量)"], bait:["青イソメ","オキアミ"], lures:["0.5–2g ジグヘッド＋ワーム","フロート"], food:"煮付け／塩焼き"},
  "カサゴ": {season:"通年（冬〜春◎）", time:"夜有利（昼は穴撃ち）", shelf:"底（テトラ・根・壁際）",
           methods:["ちょい投げ","胴突き","ブラクリ","穴釣り","テキサス"], bait:["青イソメ","サバ切り身","オキアミ"],
           lures:["テキサス＋クロー/ホッグ","ジグヘッド"], food:"唐揚げ／味噌汁／煮付け"},
  "アイナメ": {season:"晩秋〜春", time:"日中〜夕", shelf:"底（岩礁・藻場・テトラ穴）",
           methods:["ちょい投げ","ブラクリ","胴突き","前打ち"], bait:["青イソメ","エビ類","イカ短"], lures:["テキサス","ジグヘッド"], food:"昆布締め／天ぷら／煮付け"},
  "シロギス": {season:"初夏〜秋", time:"日中", shelf:"底（駆け上がり・離岸流脇）",
           methods:["ちょい投げ","投げ"], bait:["ジャリメ/イソメ","本虫"], lures:["軽量メタル","専用ワーム"], food:"天ぷら／フライ"},
  "イシモチ": {season:"陸っぱり5–11月", time:"夜と朝マズメ（濁り◎）", shelf:"底",
           methods:["ちょい投げ","胴突き"], bait:["アオイソメ","イカ短"], lures:[], food:"唐揚げ／塩焼き／煮付け"},
  "カレイ": {season:"冬〜春", time:"朝夕（置き竿可）", shelf:"底ベッタリ（船道のかけ上がり）",
           methods:["投げ"], bait:["本虫","青イソメ","アオヤギ"], lures:["ビーズ/夜光玉（装飾）"], food:"煮付け／唐揚げ"},
  "メゴチ": {season:"初夏〜秋", time:"日中", shelf:"底（駆け上がり）",
           methods:["ちょい投げ","投げ"], bait:["イソメ類"], lures:[], food:"天ぷら（骨せんべい◎)"},
  "カワハギ": {season:"秋〜冬（肝パン）", time:"日中", shelf:"底〜中層（宙釣りも）",
           methods:["胴突き","宙釣り"], bait:["アサリむき身（塩締め）"], lures:["小型ワーム可"], food:"肝醤油刺し／唐揚げ／煮付け"},
  "ギマ": {season:"梅雨〜夏", time:"日中", shelf:"底（砂地）",
           methods:["ちょい投げ"], bait:["イソメ類"], lures:[], food:"唐揚げ／味噌汁／肝和え"},

  /* ハゼ */
  "マハゼ": {season:"夏〜晩秋", time:"日中〜夕（満ち引き前後）", shelf:"底（ミオ筋・障害物際）",
           methods:["ミャク釣り","ウキ","ちょい投げ","ハゼクラ"], bait:["アオイソメ","エビ身","ホタテ","イカ短"],
           lures:["小型クランク","1g前後ジグヘッド"], food:"天ぷら／唐揚げ／甘露煮"},
  "ウロハゼ": {season:"夏〜秋", time:"日中（潮位変化を意識）", shelf:"底（護岸キワ・捨石）",
           methods:["ミャク釣り"], bait:["アオイソメ","エビ身"], lures:[], food:"唐揚げ／天ぷら"},

  /* フラットフィッシュ */
  "ソゲ": {season:"初夏〜秋", time:"朝夕・濁り後", shelf:"底上〜1m（駆け上がり・払い出し）",
           methods:["ルアー","泳がせ"], bait:["活ハゼ","小アジ"], lures:["ミノー","シンペン","ジグヘッド＋シャッド"], food:"唐揚げ／ムニエル"},
  "ヒラメ": {season:"晩秋〜冬＋春", time:"朝夕・荒れ後の回復時", shelf:"底上1m以内（離岸流・ブレイク）",
           methods:["泳がせ","ぶっこみ","ルアー"], bait:["活アジ/コノシロ/ハゼ","サバ切り身"],
           lures:["シンキングミノー","シンペン","ジグヘッド＋ワーム","メタル"], food:"刺身・昆布締め／ムニエル"},
  "マゴチ": {season:"初夏〜秋", time:"朝夕〜日中（干満前後）", shelf:"底（駆け上がり・河口ヨレ）",
           methods:["泳がせ","ぶっこみ","ルアー","エレベーター"], bait:["活ハゼ","小アジ","サバ切り身"],
           lures:["ジグヘッド＋ワーム","バイブ","メタル","テキサス"], food:"薄造り／天ぷら／ムニエル"},

  /* スズキ（成長名） */
  "セイゴ": {season:"通年（春バチ/夏秋小ベイト）", time:"夕・夜・朝マズメ", shelf:"表層〜中層（明暗・壁際・角）",
           methods:["ルアー","ウキ","ミャク釣り"], bait:["青イソメ","小魚"], lures:["50–80mmミノー","3–10gジグ","フロート"], food:"唐揚げ／塩焼き"},
  "フッコ": {season:"通年（秋最盛）", time:"夕・夜・朝マズメ", shelf:"表層〜中層（潮替わり・反転流）",
           methods:["ルアー","泳がせ","ぶっこみ"], bait:["活アジ/イワシ/コノシロ","青イソメ"], lures:["90–120mmミノー","シンペン","バイブ","30–40gジグ"], food:"ムニエル／ポワレ／塩焼き"},
  "スズキ": {season:"通年（秋ベイト・冬越冬）", time:"夕・夜・朝マズメ", shelf:"表層〜中層（払い出し・ヨレ・ブレイク）",
           methods:["ルアー","泳がせ"], bait:["活小魚"], lures:["120–140mmミノー","重めシンペン/バイブ","40gジグ","ビッグベイト"], food:"洗い／活〆刺身／ムニエル"},

  /* ブリ系（成長名） */
  "ワカシ": {season:"初夏〜秋", time:"朝マズメ", shelf:"表層〜中層（潮目・鳥山）",
           methods:["ジギング","遠投カゴ"], bait:["オキアミ（カゴ）"], lures:["30–40gメタル","ヘビーシンペン"], food:"刺身／漬け／フライ"},
  "イナダ": {season:"秋中心", time:"朝マズメ", shelf:"表層〜中層",
           methods:["ジギング","プラッギング","泳がせ"], bait:["活小魚"], lures:["40–60gメタル","ミノー"], food:"刺身／照り焼き"},
  "ワラサ": {season:"秋", time:"朝マズメ", shelf:"中層中心",
           methods:["ジギング重め","泳がせ"], bait:["活小魚"], lures:["50–80gメタル","ヘビーシンペン"], food:"刺身／照り焼き／カマ塩焼き"},
  "ブリ": {season:"秋〜初冬", time:"朝マズメ", shelf:"中層（潮目直下）",
           methods:["ジギング大型","泳がせ"], bait:["活小魚"], lures:["60–100gメタル","ビッグミノー"], food:"ブリしゃぶ／刺身／照り焼き"},

  /* サワラ系 */
  "サゴシ": {season:"秋（年により春）", time:"朝マズメ", shelf:"表層高速回遊",
           methods:["ジギング","ルアー"], bait:[], lures:["40–60gメタル","シンペン/ミノー速巻き"], food:"フライ／ムニエル"},
  "サワラ": {season:"秋（年により春）", time:"朝マズメ", shelf:"表層",
           methods:["プラッギング","ジギング"], bait:[], lures:["重めミノー/シンペン","メタル高速"], food:"炙り刺し／西京焼き"},

  /* タチウオ */
  "タチウオ": {season:"夏後半〜晩秋", time:"夕まずめ〜夜", shelf:"中層〜上層（当たりレンジ固定）",
           methods:["ウキ","テンヤ","ワインド","ジギング"], bait:["キビナゴ","ドジョウ","サンマ切り身"],
           lures:["30–60gメタル","ワインド","バイブ"], food:"塩焼き／天ぷら／炙り刺し"},

  /* クロダイ・キビレ */
  "クロダイ": {season:"春ノッコミ＋夏秋", time:"日中〜夕（濁り◎）", shelf:"底〜中層（壁際30cm）",
           methods:["落とし込み","前打ち","フカセ","ぶっこみ","ルアー"], bait:["カニ","イガイ","オキアミ","コーン"],
           lures:["テキサス/フリーリグ","バイブ"], food:"刺身／塩焼き／煮付け"},
  "キビレ": {season:"初夏〜秋", time:"夕〜夜（風波◎）", shelf:"底（護岸キワ）",
           methods:["落とし込み","チニング","ぶっこみ"], bait:["カニ","青イソメ"],
           lures:["テキサス/フリーリグ","シャッド/クロー"], food:"カルパッチョ／塩焼き"},

  /* ボラ */
  "オボコ/スバシリ": {season:"春〜初夏", time:"日中", shelf:"表層",
           methods:["ウキ","コマセ"], bait:["パン","練り餌"], lures:[], food:"（観察・リリース推奨）"},
  "イナ（ボラ若魚）": {season:"夏〜秋", time:"日中〜夕", shelf:"表層〜中層",
           methods:["フカセ","ウキ","ルアー外道"], bait:["パン","練り餌","アミ"], lures:["小型メタル","ミノー"], food:"洗い／味噌汁"},
  "ボラ": {season:"通年（寒ボラは冬）", time:"日中〜夕", shelf:"表層〜中層",
           methods:["コマセ","ウキ","ルアー外道"], bait:["パン","練り餌","アミ"], lures:["小型メタル","ミノー"], food:"洗い／味噌汁／卵はカラスミ"},

  /* 河口・長物 */
  "ウナギ": {season:"初夏〜秋（※規制確認必須）", time:"夜（雨後・濁り◎）", shelf:"底（ヘチ・泥底）",
           methods:["ぶっこみ"], bait:["ミミズ/ドバ","ハゼ/サバ切り身"], lures:[], food:"白焼き／蒲焼（地域ルール厳守）"},
  "マアナゴ": {season:"晩春〜夏（陸）", time:"日没〜21時台", shelf:"底（砂泥底・船道）",
           methods:["ぶっこみ","胴突き"], bait:["アオイソメ束","イカ短","青魚切り身"], lures:[], food:"天ぷら／煮アナゴ／白焼き"},
  "アカエイ": {season:"夏（高水温期）", time:"日中〜夜", shelf:"底（砂泥底・河口）",
           methods:["ぶっこみ"], bait:["サバ/イカ切り身","貝類"], lures:[], food:"ヒレ煮凝り/唐揚げ（※毒棘注意）"},

  /* 頭足類 */
  "アオリイカ（新子）": {season:"秋（9–11月）", time:"朝夕〜夜", shelf:"表層〜中層（藻場・壁際）",
           methods:["エギング"], bait:[], lures:["エギ 2.5–3号"], food:"刺身／天ぷら"},
  "アオリイカ（親イカ）": {season:"春（4–6月）", time:"朝夕〜夜", shelf:"中層（やや深め）",
           methods:["エギング"], bait:[], lures:["エギ 3.0–3.5号＋シンカー"], food:"刺身／塩焼き／バター焼き"},
  "モンゴウイカ": {season:"秋〜春", time:"日中中心", shelf:"底上10–20cm（砂泥底）",
           methods:["エギング","スッテ","（船）餌巻きテーラ"], bait:[], lures:["エギ3.0–3.5号","スッテ"], food:"天ぷら／刺身／墨煮"},
  "マダコ": {season:"初夏〜秋（6–8月）", time:"日中", shelf:"底（ストラクチャー直撃）",
           methods:["タコエギ","テンヤ"], bait:["カニ","サバ身（テンヤ）"], lures:["タコエギ","スッテ"], food:"茹で／唐揚げ／ガーリックバター"}
};

/* ========= 釣り場DB（前回どおり：東京都の例） ========= */
const DB = [
  { id:"wakasu", pref:"東京都", city:"江東区", name:"若洲海浜公園（海釣り施設・人工磯）",
    address:"東京都江東区若洲3丁目",
    map:"https://maps.google.com/?q=%E8%8B%A5%E6%B4%B2%E6%B5%B7%E6%BF%B1%E5%85%AC%E5%9C%92%20%E6%B5%B7%E9%87%A3%E3%82%8A%E6%96%BD%E8%A8%AD",
    zones:[ {type:"堤防", fishes:["豆アジ","アジ","イワシ","コノシロ","メバル","シーバス","サバ","サヨリ"]},
            {type:"テトラ/人工磯", fishes:["カサゴ","メバル","シーバス"]}],
    methods:["サビキ","ロケットサビキ","ちょい投げ","投げ","ウキ","ルアー","ルアー(軽量)","胴突き","ブラクリ","ミャク釣り","フカセ","ぶっこみ","エレベーター","ジギング","テンヤ","ワインド","エギング"],
    shelf:"堤防角の明暗／人工磯の石間（穴打ち）／表層〜中層回遊",
    times:"朝夕マズメとナイト有利", rules:"安全柵あり・混雑多め。ライフジャケット推奨。" },
  { id:"toyosu-gururi", pref:"東京都", city:"江東区", name:"豊洲ぐるり公園（護岸）",
    address:"江東区豊洲6丁目ほか",
    map:"https://maps.google.com/?q=%E8%B1%8A%E6%B4%B2%E3%81%90%E3%82%8B%E3%82%8A%E5%85%AC%E5%9C%92",
    zones:[ {type:"護岸", fishes:["ハゼ","セイゴ","メバル","カサゴ","クロダイ","サヨリ","コノシロ"]}],
    methods:["ミャク釣り","ヘチ・落とし込み","ルアー","ルアー(軽量)","ウキ","ちょい投げ","ぶっこみ","フカセ"],
    shelf:"柵際のキワ／橋・常夜灯の明暗／足元のカケ上がり",
    times:"ハゼは日中、シーバスは夜の明暗", rules:"撒き餌/トリックサビキ/ロケット天秤禁止。歩行者最優先。" },
  // ...（他スポットは前回どおり。省略可）
];

/* 都道府県一覧 */
const PREFS = [...new Set(DB.map(p=>p.pref))];

/* ========= 状態とステップ ========= */
const state = { step:0, pref:null, placeId:null, zoneIdx:null, fish:null, subMethod:null };
const stepsTitle = ["都道府県","釣り場","ポイント種別","魚種","結果"];

function setSteps(){
  const s = document.getElementById('steps');
  s.innerHTML = stepsTitle.map((t,i)=>`<div class="step ${i<=state.step?'on':''}">${i+1}. ${t}</div>`).join('');
  document.getElementById('back').hidden = state.step===0;
}

/* ========= 画面描画 ========= */
function render(){
  setSteps();
  const app = document.getElementById('app');

  // 0: 都道府県
  if(state.step===0){
    app.innerHTML = `<div class="hero"><strong>都道府県</strong> を選ぶと、その地域の釣り場が出ます。</div>
    <div class="grid">
      ${PREFS.map(p=>{
        const n = DB.filter(d=>d.pref===p).length;
        return `<div class="card">
          <h3>${p}</h3>
          <p class="muted">${n} スポット</p>
          <div class="row"><button class="pri" onclick="selPref('${p}')">この都道府県を選ぶ</button></div>
        </div>`}).join('')}
    </div>`;
    return;
  }

  // 1: 釣り場
  if(state.step===1){
    const list = DB.filter(d=>d.pref===state.pref);
    app.innerHTML = `<div class="grid">
      ${list.map(d=>`
        <div class="card">
          <h3>${d.name}</h3>
          <div class="kv"><span>${d.pref} ${d.city||""}</span><span>${d.address||""}</span></div>
          <div class="row">
            <button class="ghost" onclick="openMap('${d.id}')">地図を開く</button>
            <button class="pri" onclick="selPlace('${d.id}')">ここを選ぶ</button>
          </div>
        </div>`).join('')}
    </div>`;
    return;
  }

  // 2: ポイント種別
  if(state.step===2){
    const p = getPlace();
    app.innerHTML = `
      <div class="card">
        <h3>${p.name}｜ポイントを選ぶ</h3>
        <div class="chips">
          ${p.zones.map((z,idx)=>`<button class="chip" onclick="selZone(${idx})">${z.type}</button>`).join('')}
        </div>
      </div>`;
    return;
  }

  // 3: 魚種（ポイントで絞り込み）
  if(state.step===3){
    const z = getZone();
    app.innerHTML = `
      <div class="card">
        <h3>${getPlace().name}｜${z.type}｜魚種を選ぶ</h3>
        <div class="chips">
          ${z.fishes.map(f=>`<button class="chip" onclick="selFish('${f}')">${f}</button>`).join('')}
        </div>
      </div>`;
    return;
  }

  // 4: 結果（釣り方はここでチップ切替）
  if(state.step===4){
    app.innerHTML = renderResult();
    return;
  }
}

function renderResult(){
  const p = getPlace(), z = getZone(), f = state.fish;
  const info = FISH_BOOK[f] || {};
  const placeMethods = (p.methods||[]);
  const allowed = (info.methods||[]).filter(m => placeMethods.includes(m));
  if(!state.subMethod) state.subMethod = allowed[0] || null;

  // 画像：魚 & 仕掛け
  const fimg = fishImg(f);
  const rimg = rigImg(f, state.subMethod);

  // パラメータピル
  const params = `
    <div class="params">
      <div class="param"><b>シーズン</b> ${info.season||"—"}</div>
      <div class="param"><b>時間帯</b> ${info.time||"—"}</div>
    </div>`;

  // 釣法チップ（ページ内切替）
  const methodChips = `
    <div class="chips method-chips">
      ${allowed.map(m=>`<button class="chip ${m===state.subMethod?'on':''}" onclick="pickMethod('${m}')">${m}</button>`).join('') || '<p class="muted">この場所で推奨される釣法データが未設定です</p>'}
    </div>`;

  // オススメ部材：魚固有 + 釣法定義から生成
  const gearWords = new Set([...(info.gear||[])]);
  (METHOD_GEAR[state.subMethod]||[]).forEach(w=>gearWords.add(w));
  const gearList = [...gearWords].slice(0,6);

  // 餌・撒き餌：魚固有の餌 + 釣法別の餌提案
  const baitWords = new Set([...(info.bait||[])]);
  (BAIT_BY_METHOD[state.subMethod]||[]).forEach(w=>baitWords.add(w));
  const baitList = [...baitWords];

  // ルアー（魚固有）
  const lureList = info.lures||[];

  return `
  <div class="card">
    <div class="sectionTitle">指定した魚画像 ↓</div>
    <img class="banner" src="${fimg}" alt="${f}" onerror="this.onerror=null;this.src='${FISH_IMG_FALLBACK}';">

    <div class="sectionTitle">仕掛けイラスト ↓</div>
    <img class="banner" src="${rimg.specific}" alt="${state.subMethod||''} rig"
         onerror="if(this.src.indexOf('rig-')>-1){this.src='${rimg.generic}';this.onerror=function(){this.src='${rimg.placeholder}';}}">

    <h3 style="margin-top:10px">${p.name}</h3>
    <div class="kv"><span>${z.type}</span><span>魚種：${f}</span></div>
    ${params}

    <div class="sectionTitle">この場所での推奨釣り方（切り替え可）</div>
    ${methodChips}

    <div class="sectionTitle">オススメ部材 ↓</div>
    ${gearList.length?`<ul class="items">
      ${gearList.map(w=>`<li>${w}
        <div class="shops">
          <a class="shop" href="#" onclick="ext('${linkAmazon(w)}')">Amazon</a>
          <a class="shop" href="#" onclick="ext('${linkRakuten(w)}')">楽天</a>
        </div>
      </li>`).join('')}
    </ul>`:'<p class="muted">準備中</p>'}

    <div class="sectionTitle">餌・撒き餌のオススメ ↓</div>
    ${baitList.length?`<ul class="items">
      ${baitList.map(w=>`<li>${w}
        <div class="shops">
          <a class="shop" href="#" onclick="ext('${linkAmazon(w)}')">Amazon</a>
          <a class="shop" href="#" onclick="ext('${linkRakuten(w)}')">楽天</a>
        </div>
      </li>`).join('')}
    </ul>`:'<p class="muted">準備中</p>'}

    ${lureList.length?`<div class="sectionTitle">ルアー候補 ↓</div>
      <ul class="items">
        ${lureList.map(w=>`<li>${w}
          <div class="shops">
            <a class="shop" href="#" onclick="ext('${linkAmazon(w)}')">Amazon</a>
            <a class="shop" href="#" onclick="ext('${linkRakuten(w)}')">楽天</a>
          </div>
        </li>`).join('')}
      </ul>`:''}

    <div class="sectionTitle">棚、狙い目 ↓</div>
    <p>${(FISH_BOOK[f]?.shelf)||p.shelf||'—'}</p>

    <div class="sectionTitle">おすすめ時間帯 ↓</div>
    <p>${(FISH_BOOK[f]?.time)||p.times||'—'}</p>

    <div class="sectionTitle">現地ルール（備考） ↓</div>
    <p class="muted">${p.rules||'安全第一でお願いします。'}</p>

    <div class="sectionTitle">場所と友だち共有</div>
    <div class="row" style="margin-top:6px">
      <button class="ghost" onclick="openMap('${p.id}')">場所を地図で確認</button>
      <button class="pri" onclick="share()">友だちに共有</button>
    </div>

    <p class="cap">食べ方ヒント：${(FISH_BOOK[f]?.food)||'—'}</p>
  </div>`;
}

/* ========= ハンドラ ========= */
function getPlace(){ return DB.find(p=>p.id===state.placeId); }
function getZone(){ const p = getPlace(); return p?.zones?.[state.zoneIdx]; }
function openWin(url){ return liff.isInClient()? liff.openWindow({url, external:true}) : window.open(url,'_blank'); }
function openMap(pid){ const url = DB.find(p=>p.id===pid).map; openWin(url); }
function ext(url){ openWin(url); }

function selPref(p){ state.pref=p; state.step=1; render(); }
function selPlace(id){ state.placeId=id; state.step=2; render(); }
function selZone(idx){ state.zoneIdx=idx; state.step=3; render(); }
function selFish(f){ state.fish=f; state.subMethod=null; state.step=4; render(); }
function pickMethod(m){ state.subMethod=m; document.getElementById('app').innerHTML = renderResult(); }

function goBack(){
  if(state.step===0) return;
  if(state.step===1){ state.pref=null; }
  if(state.step===2){ state.placeId=null; }
  if(state.step===3){ state.zoneIdx=null; }
  if(state.step===4){ state.fish=null; state.subMethod=null; }
  state.step--; render();
}

/* ===== LIFF 起動 ===== */
(async()=>{
  await liff.init({ liffId: LIFF_ID });
  if (liff.isInClient()){
    if(!liff.isLoggedIn()){ liff.login({ prompt:"consent" }); return; }
    try{
      const p = await liff.getProfile();
      document.getElementById('hello').textContent = `ようこそ ${p.displayName} さん`;
    }catch{ document.getElementById('hello').textContent = "ようこそ！"; }
  }else{
    document.getElementById('hello').textContent = "ブラウザでプレビュー中";
  }
  render();
})();

async function share(){
  if(!liff.isInClient()){ alert('共有はLINEアプリ内で開いてください'); return; }
  const p = getPlace(), z = getZone();
  const f = state.fish, m = state.subMethod||'';
  const msg = `${p.name}\n${z.type}\n${f}${m?` × ${m}`:''}\n季節:${FISH_BOOK[f]?.season||'-'}／時間帯:${FISH_BOOK[f]?.time||'-'}\n棚:${FISH_BOOK[f]?.shelf||p.shelf||'-'}\n地図:${p.map}`;
  await liff.shareTargetPicker([{ type:'text', text: msg }]);
}
</script>
</body>
</html>
